/*! Websql - v0.1.0 - 2013-10-17
* https://github.com/yelouafi/websql.js
* Copyright (c) 2013 Elouafi Yassine; Licensed MIT */
var websql=websql||{},utils=utils||{};!function(a){websql.Db=function(b,c,d,e){var f=this;this.dbType="SQLite",this.tables=[];var g=/^(\d{4}|\+\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2}):(\d{2})\.(\d{1,3})(?:Z|([\-+])(\d{2}):(\d{2}))?)?)?)?$/;this.client=openDatabase(b,c||"1.0",d||b,e||2097152),this.tableSQL="SELECT name FROM sqlite_master	WHERE type='table' ORDER BY name",this.modelsTableSchema={columns:{model:"text"}},this.model={tables:{}},f.debug=!1,f.log=function(a){f.debug&&console.log(a)},this.placeholder=function(){return"?"},this.typeToDb=function(a){return utils.isDate(a)?a.toISOString():utils.isBoolean(a)?a?1:0:a},this.processRow=function(a){var b={};for(var c in a){var d=a[c];if(utils.isString(d)&&d.match(g)){var e=Date.parse(d);e&&(d=new Date(e))}b[c]=d}return b};var h=function(a){var b=a;switch(a){case"pk":b="INTEGER PRIMARY KEY  AUTOINCREMENT";break;case"int":b="INTEGER";break;case"decimal":b="numeric";break;case"date":b="datetime";break;case"text":b="text";break;case"boolean":b="boolean"}return b};this.forward=function(b,c){return a.Deferred(function(a){a.resolve(b,c)}).promise()};var i=function(a){return function(b,c){var d;if(0===a.sql.indexOf("insert"))d=c.insertId;else if(0===a.sql.indexOf("select")){var e,g=c.rows.length;for(d=[],e=0;g>e;e++){var h=f.processRow(c.rows.item(e));d.push(h)}0===a.sql.indexOf("select count(1)")?d=d[0]["COUNT(1)"]:a.sql.indexOf("limit(1)")>0&&(d=d[0])}else d=c.rowsAffected;a.resolve(d,b)}},j=function(a){return function(b,c){return f.log("sql error on : "+a.sql+" --- message: "+c.message),a.reject(c),!0}};f.exec=function(){var b,c,d;utils.isString(arguments[0])?(b=null,c=arguments[0],d=arguments[1]):(b=arguments[0],c=arguments[1],d=arguments[2]);var e=d?d.join(", "):"";return f.log("exec : "+c+" : ["+e+"]"),a.Deferred(function(a){var e=d?d.map(f.typeToDb):d;a.sql=c.toLowerCase(),b?b.executeSql(c,e,i(a),j(a)):f.client.transaction(function(b){b.executeSql(c,e,i(a),j(a))})})},this.getQuery=function(a,b){return new websql.Query(a,b,new websql.Table("","",f))},this.fnRunQuery=function(a){return function(b,c){return a.run(c)}},this.runQueries=function(a,b){for(var c=a[0].run(b),d=1;d<a.length;d++){var e=a[d];c=c.then(f.fnRunQuery(e))}return c},this.runSqls=function(a,b){var c=new websql.Table("","",f),d=a.map(function(a){return Array.isArray(a)?new websql.Query(a[0],a.slice(1),c):new websql.Query(a.toString(),[],c)});return f.runQueries(d,b)},this.dropTable=function(a){return new websql.Query("DROP TABLE IF EXISTS "+a,[],new websql.Table(a,"",f))};var k=function(a,b){return utils.isString(b)?a+" "+h(b):a+" "+h(b.type)+(b.required?" NOT NULL":"")+(b.unique?" UNIQUE":"")};this.createTable=function(a,b,c){var d="CREATE TABLE "+(c?"IF NOT EXISTS ":"")+a+"(",e=[];e.push(k("id","pk"));for(var g in b)"timestamps"===g?(e.push("created_at int"),e.push("updated_at int")):"id"!==g&&e.push(k(g,b[g]));return d+=e.join(", ")+")",new websql.Query(d,[],new websql.Table(a,"id",f))},this.createColumn=function(a,b,c){return new websql.Query("ALTER TABLE "+a+" ADD COLUMN "+k(b,c),[],new websql.Table(a,"",f))},this.createModelsTable=function(){return f.createTable("_models",f.modelsTableSchema.columns,!0)},this.loadModel=function(a){var b=f.createModelsTable().run(a).then(function(a,b){return f._models=new websql.Table("_models","id",f),f._models.last(b)}).then(function(a,b){return a&&(f.model=JSON.parse(a.model)),f.forward(f.newModel,b)});return b},this.reloadModel=function(a){f._models.last(a).then(function(a,b){return a&&(f.model=JSON.parse(a.model)),f.forward(f.newModel,b)})},this.upgrade=function(a,b){return f.loadModel(b).then(function(b,c){var d=[];return utils.each(a.tables,function(b,c){if(utils.has(f.model.tables,c)){var e=f.model.tables[c],g=a.tables[c];utils.each(g,function(a,b){utils.has(e,b)||d.push(f.createColumn(c,b,a))})}else d.push(f.createTable(c,b))}),d.length?(d.push(f._models.insert({model:JSON.stringify(a)})),f.runQueries(d,c)):f.forward(b,c)}).then(function(b,c){return f.model=a,utils.each(a.tables,function(a,b){f[b]=new websql.Table(b,"id",f)}),f.forward(b,c)})}},websql.Query=function(a,b,c){var d={"=":"=","!":"!=",">":">","<":"<",">=":">=","<=":"<=","!=":"<>","<>":"<>"},e=this;e.sql=a,e.params=b||[],e.table=c,e.db=c.db,e.append=function(a){return e.sql+=1===arguments.length?a:utils.format.apply(null,utils.toArray(arguments)),e},e.order=function(a,b){return e.append(" ORDER BY {0}{1}",a,b?" DESC":"")},e.limit=function(a,b){return utils.isUndef(b)?e.append(" LIMIT {0}",a):e.append(" LIMIT {0} OFFSET {1}",a,b)},e.first=function(){return e.append(" LIMIT(1)")},e.last=function(){return e.append(" ORDER BY {0} DESC LIMIT(1)",e.table.pk)},e.where=function(a){if(utils.isUndef(a))return e;if(utils.isNumber(a))return e.append(' WHERE "{0}" = {1}',e.table.pk,a);if(utils.isString(a))return e.params.push(a),e.append(' WHERE "{0}" = {1}',e.table.pk,e.db.placeholder(e.params.length));var b=[];for(var c in a){var f=a[c],g=c.trim().split(/ +/),h=g[0],i=d[g[1]]||"=";if(Array.isArray(f)){var j=[];f.forEach(function(a){e.params.push(a),j.push(e.db.placeholder(e.params.length))}),b.push(utils.format('"{0}" {1} ({2})',h,"!="===i||"<>"===i?"NOT IN":"IN",j.join(", ")))}else e.params.push(f),b.push(utils.format('"{0}" {1} {2}',h,i,e.db.placeholder(e.params.length)))}return e.append(" WHERE "+b.join(" AND "))},e.parseArgs=function(a){var b=utils.toArray(a);if(0===b.length)return e;var c;return b.forEach(function(a){if(utils.isNumber(a)||utils.isString(a)){var b={};b[e.table.pk]=a,e.where(b)}else if(Array.isArray(a))c=a;else if(utils.isObject(a)){var d=a.where||a;c=a.columns,utils.isObject(d)&&e.where(d)}}),c&&(e.sql=e.sql.replace("*",c.join(","))),e},this.find=function(){return e.sql="select * from "+e.table.name,e.parseArgs(arguments)},this.run=function(a){return e.db.exec(a,e.sql,e.params)}},websql.Table=function(a,b,c){var d=this;this.name=a,this.pk=b,this.db=c,this.find=function(){return new websql.Query("SELECT * FROM "+this.name,[],this).parseArgs(arguments)},this.first=function(a){return d.find().first().run(a)},this.last=function(a){return d.find().last().run(a)},this.insert=function(a){if(!a)throw"insert should be called with data";var b=utils.format("INSERT INTO {0} ({1}) VALUES(",d.name,Object.keys(a).join(", ")),c=[],e=[],f=0;for(var g in a)e.push(d.db.placeholder(++f)),c.push(a[g]);return b+=e.join(", ")+")",new websql.Query(b,c,d)},this.update=function(a,b){if(utils.isObject(a)===!1)throw"Update requires a hash of fields=>values to update to";var c=[],e=[],f=0;for(var g in a)e.push(g+" = "+d.db.placeholder(++f)),c.push(a[g]);var h=utils.format("UPDATE {0} SET {1}",this.name,e.join(", "));return new websql.Query(h,c,d).where(b)}}}(jQuery);